name: PR Auto Review and Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '_posts/**/*.md'
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  validate-article:
    name: Validate Article Submission
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      auto_approve: ${{ steps.check.outputs.auto_approve }}
      validation_result: ${{ steps.check.outputs.result }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Checkout PR branch
        run: |
          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr-${{ github.event.pull_request.number }}
          git checkout pr-${{ github.event.pull_request.number }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pyyaml
      
      - name: Get changed files
        id: changed-files
        run: |
          git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt
      
      - name: Validate articles
        id: check
        run: |
          # å¤‰æ›´ã•ã‚ŒãŸMarkdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œè¨¼
          results=()
          auto_approve_all=true
          
          while IFS= read -r file; do
            if [[ "$file" == _posts/*.md ]] && [[ "$file" != "_posts/template.md" ]]; then
              echo "Validating: $file"
              
              # å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªï¼ˆæ›´æ–°ã®å ´åˆï¼‰
              original_file=""
              if git show origin/${{ github.base_ref }}:"$file" > /tmp/original.md 2>/dev/null; then
                original_file="/tmp/original.md"
              fi
              
              # æ¤œè¨¼å®Ÿè¡Œ
              if [ -n "$original_file" ]; then
                python scripts/check_pr.py "$file" "$original_file" > validation_result.json
              else
                python scripts/check_pr.py "$file" > validation_result.json
              fi
              
              # çµæœã‚’è¡¨ç¤º
              cat validation_result.json
              
              # auto_approve ã®å€¤ã‚’å–å¾—
              auto_approve=$(jq -r '.auto_approve' validation_result.json)
              if [ "$auto_approve" != "true" ]; then
                auto_approve_all=false
              fi
              
              # çµæœã‚’ä¿å­˜
              results+=("$(cat validation_result.json)")
            fi
          done < changed_files.txt
          
          # å‡ºåŠ›ã‚’è¨­å®š
          echo "auto_approve=$auto_approve_all" >> $GITHUB_OUTPUT
          echo "result<<EOF" >> $GITHUB_OUTPUT
          printf '%s\n' "${results[@]}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Post validation result
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let validationResult;
            try {
              validationResult = JSON.parse(fs.readFileSync('validation_result.json', 'utf8'));
            } catch (error) {
              console.log('Could not read validation result');
              return;
            }
            
            let comment = '## ğŸ“ è¨˜äº‹æ¤œè¨¼çµæœ\n\n';
            
            if (validationResult.is_spam) {
              comment += 'âŒ **ã‚¹ãƒ‘ãƒ åˆ¤å®š**: ã“ã®è¨˜äº‹ã¯ã‚¹ãƒ‘ãƒ ã¨åˆ¤å®šã•ã‚Œã¾ã—ãŸã€‚\n\n';
            } else if (!validationResult.is_valid_format) {
              comment += 'âš ï¸ **å½¢å¼ã‚¨ãƒ©ãƒ¼**: è¨˜äº‹ã®å½¢å¼ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚\n\n';
            } else if (validationResult.auto_approve) {
              if (validationResult.issues && validationResult.issues.length > 0) {
                comment += 'âœ… **æ‰¿èªå¯èƒ½ï¼ˆæ”¹å–„ææ¡ˆã‚ã‚Šï¼‰**: è¨˜äº‹ã¯é©åˆ‡ã§ã™ï¼\n\n';
                comment += 'æŠ•ç¨¿è€…ã¯ `@publish` ã¨ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã“ã¨ã§è‡ªå‹•ãƒãƒ¼ã‚¸ã§ãã¾ã™ã€‚\n';
                comment += 'ä»¥ä¸‹ã®æ”¹å–„ææ¡ˆã¯ä»»æ„ã§ã™ï¼ˆãƒãƒ¼ã‚¸å‰ã«ä¿®æ­£ã—ãªãã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ï¼‰ã€‚\n\n';
              } else {
                comment += 'âœ… **æ‰¿èªå¯èƒ½**: è¨˜äº‹ã¯å®Œç’§ã§ã™ï¼\n\n';
                comment += 'æŠ•ç¨¿è€…ã¯ `@publish` ã¨ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã“ã¨ã§è‡ªå‹•ãƒãƒ¼ã‚¸ã§ãã¾ã™ã€‚\n\n';
              }
            } else {
              comment += 'âš ï¸ **è¦ç¢ºèª**: å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚\n\n';
            }
            
            comment += `**åˆ¤å®šã‚µãƒãƒªãƒ¼**: ${validationResult.summary}\n\n`;
            
            if (validationResult.issues && validationResult.issues.length > 0) {
              comment += '### å•é¡Œç‚¹\n\n';
              validationResult.issues.forEach(issue => {
                comment += `- ${issue}\n`;
              });
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

  auto-merge:
    name: Auto Approve and Merge
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@publish')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get PR number
        id: pr
        run: |
          echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
      
      - name: Check if commenter is PR author
        id: check-author
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.pr.outputs.number }}
            });
            
            const isAuthor = pr.data.user.login === context.payload.comment.user.login;
            console.log(`PR author: ${pr.data.user.login}`);
            console.log(`Comment author: ${context.payload.comment.user.login}`);
            console.log(`Is author: ${isAuthor}`);
            
            core.setOutput('is_author', isAuthor);
            return isAuthor;
      
      - name: Checkout PR branch
        if: steps.check-author.outputs.is_author == 'true'
        run: |
          git fetch origin pull/${{ steps.pr.outputs.number }}/head:pr-${{ steps.pr.outputs.number }}
          git checkout pr-${{ steps.pr.outputs.number }}
      
      - name: Set up Python
        if: steps.check-author.outputs.is_author == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        if: steps.check-author.outputs.is_author == 'true'
        run: |
          pip install pyyaml
      
      - name: Re-validate articles
        if: steps.check-author.outputs.is_author == 'true'
        id: validate
        run: |
          git diff --name-only origin/main...HEAD > changed_files.txt
          
          auto_approve_all=true
          
          while IFS= read -r file; do
            if [[ "$file" == _posts/*.md ]] && [[ "$file" != "_posts/template.md" ]]; then
              echo "Re-validating: $file"
              
              original_file=""
              if git show origin/main:"$file" > /tmp/original.md 2>/dev/null; then
                original_file="/tmp/original.md"
              fi
              
              if [ -n "$original_file" ]; then
                python scripts/check_pr.py "$file" "$original_file" > validation_result.json
              else
                python scripts/check_pr.py "$file" > validation_result.json
              fi
              
              cat validation_result.json
              
              auto_approve=$(jq -r '.auto_approve' validation_result.json)
              if [ "$auto_approve" != "true" ]; then
                auto_approve_all=false
              fi
            fi
          done < changed_files.txt
          
          echo "auto_approve=$auto_approve_all" >> $GITHUB_OUTPUT
      
      - name: Approve PR
        if: |
          steps.check-author.outputs.is_author == 'true' &&
          steps.validate.outputs.auto_approve == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.pr.outputs.number }},
              event: 'APPROVE',
              body: 'âœ… è‡ªå‹•æ‰¿èª: è¨˜äº‹ã¯é©åˆ‡ã§ã™ã€‚è‡ªå‹•çš„ã«ãƒãƒ¼ã‚¸ã—ã¾ã™ã€‚'
            });
      
      - name: Merge PR
        if: |
          steps.check-author.outputs.is_author == 'true' &&
          steps.validate.outputs.auto_approve == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: ${{ steps.pr.outputs.number }},
                merge_method: 'squash'
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ steps.pr.outputs.number }},
                body: 'ğŸ‰ è¨˜äº‹ãŒè‡ªå‹•çš„ã«ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸï¼æŠ•ç¨¿ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚'
              });
            } catch (error) {
              console.error('Merge failed:', error);
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ steps.pr.outputs.number }},
                body: 'âŒ è‡ªå‹•ãƒãƒ¼ã‚¸ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + error.message
              });
            }
      
      - name: Comment if not author
        if: steps.check-author.outputs.is_author != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }},
              body: 'âš ï¸ `@publish` ã‚³ãƒãƒ³ãƒ‰ã¯PRã®ä½œæˆè€…ã®ã¿ãŒä½¿ç”¨ã§ãã¾ã™ã€‚'
            });
      
      - name: Comment if validation failed
        if: |
          steps.check-author.outputs.is_author == 'true' &&
          steps.validate.outputs.auto_approve != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr.outputs.number }},
              body: 'âŒ æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨˜äº‹ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚'
            });
